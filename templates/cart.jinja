{% extends "layout.jinja" %}



{% block header %} {% include 'header.jinja' %} {% endblock %}


{% block top_links %}
    <link rel="stylesheet" type="text/css" href="{{ 'toastr.min.css' | asset_url }}" />
    <link rel="stylesheet" type="text/css" href="{{ 'cart.css?v=1.40' | asset_url }}" />
{% endblock %}

{% block main_content %}

    <section class="breadcrumb-section">
        <nav aria-label="breadcrumb">
        
            <ol class="breadcrumb">
            <div class="container d-flex flex-wrap">
                 <li class="breadcrumb-item active " aria-current="page">{{ _("Cart") }}</li>
            </div>
        
            </ol>
    
        </nav>
    </section>


    <div class="modal" id="searchCitiesModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-body" style="padding: 10px 20px 20px">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>

              <h5 class="text-center py-3 mb-0 text-color-primary">
                {{ _("Enjoy free shipping for the cities") }}
              </h5>

              <div class="p-2 d-lg-flex align-items-center bd-highlight search-input lg-search-div flex-grow-1">
                <div class="form-group" style="position: relative; margin: 0px">
                    <span class="icon-search search-input-icon" style="z-index: 1"></span>
                    <div class="autocomplete" style="position: relative">
                        <input type="text" data-cat-id="" class="form-control cities-search-input pl-5" placeholder="{{ _("Search") }}">
                    </div>
                </div>
            </div>

              <div>
                <p class="cities-result lead">
                  {% for city in cart.free_shipping_rule.shipping_cities_condition %}
                    {{ city.name }}
                    {% if not loop.last %} {{ _(",") }} {% endif %}
                  {% endfor %}
                </p>
              </div>

              <div class="d-flex justify-content-center mt-3">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal" style="width: 120px">{{ _("Cancel") }}</button>
              </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container mb-5">
        <div class="cart-view">
            <div class="row cart-products-with-totals {% if cart.products_count <= 0 %}d-none{% endif %}">
                <div class="col-12 col-lg-8">
                    <div class="section-cart-products">
                        <h2 class="section-title ">{{ _("Products") }}</h2>
                        <div class="header-wrapper">
                            <div class="section-cart-products-row d-flex">
                                <div class="section-cart-products-col-1"></div>
                                <div class="section-cart-products-col-2 flex-grow-1">{{ _("Product") }}</div>
                                <div class="section-cart-products-col-3">{{ _("Quantity") }}</div>
                                <div class="section-cart-products-col-4">{{ _("Price") }}</div>
                            </div>
                        </div>

                        <div class="template_for_cart_products_list">
                            {% include 'vitrin:cart/products_list.jinja' %}
                        </div>

                        {% if cart.gift_card_details and cart.gift_card_details | length > 0 %}
                            <div class="cart-gift-card">
                                <p class="font-weight-bold mb-2">
                                    <img src="{{ 'gift_icon.png' | asset_url }}" style="display: inline-block" />
                                    {{ _('The following products will be sent as a gift') }}
                                </p>
                                <p class="mb-2">
                                    <span>{{ _("From") }}: {{cart.gift_card_details.sender_name}}</span>
                                    <span class="mx-2">{{ _("To") }}: {{cart.gift_card_details.receiver_name}}</span>
                                </p>
                                {% if cart.gift_card_details.gift_message and cart.gift_card_details.gift_message | length > 0 %}
                                    <p class="mb-0">
                                        <span>{{ _('Message') }}: </span> {{ cart.gift_card_details.gift_message }}
                                    </p>
                                {% endif %}
                            </div>
                        {% endif %}

                    </div>
                </div>
                <div class="col-12 col-lg-4">

                    <h2 class="section-title ">{{ _("Total summary") }}</h2>
                    <div class="header-wrapper">
                        <div class="section-cart-products-row section-cart-totals-row  d-flex">
                            <div class="flex-grow-1">{{ _("name") }}</div>
                            <div class="flex-shrink-0" style="width: 30%">{{ _("value") }}</div>
                        </div>
                    </div>

                    <div>{{ template_for_cart_loyalty_points_widget }}</div>

                    <div class="cart-totals-div">
                        {% for cartTotal in cart.totals %}
                            <div class="cart-product-row-wrapper cart-totals-row-wrapper">
                                <div class="flex-grow-1">
                                    {{ cartTotal.title }}
                                    {% if cartTotal.code == 'total' and store.settings.general.tax_settings.is_tax_included_in_product_price %}&nbsp;<small>{{ _('Includes TAX %(percentage)s') | format(percentage=store.settings.general.tax_settings.tax_percentage) }}</small>{% endif %}
                                </div>
                                <div class="flex-shrink-0" style="width: 30%; {% if cartTotal.code == 'total' %} font-weight: bold; color: var( --primary-color); {% endif %}">
                                    {{ cartTotal.value_string }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div> 
                    {% include 'vitrin:cart/payment_widgets.jinja' %}</div>


                    <div class="coupon-form mt-5">
                        <form>
                            <div class="form-group">
                                <h4>{{ _("Discount coupon") }}</h4>
                                <div class="d-flex">
                                    <input class="form-control send-coupon" type="text" placeholder="{{ _("Enter discount coupon") }}" />
                                    <button type="button" class="btn btn-primary" onclick="sendCoupon()">
                                        <img class="send-coupon-progress d-none" src="{{ 'spinner.gif' | asset_url }}" width="15" height="15"/>
                                    {{ _("Send") }}
                                    </button>
                                </div>
                            </div>
                        </form>


                        {% if cart.coupon.message %}
                            <div class="message-coupon alert alert-primary" role="alert">
                                <span>{{ cart.coupon.message }}</span>&nbsp;
                                <a onclick="deleteCoupon()" style="color: inherit; cursor: pointer">
                                    <span class="icon-trash-alt"></span>
                                    <img class="delete-coupon-progress d-none" src="{{ 'spinner.gif' | asset_url }}" width="15" height="15"/>
                                </a>
                            </div>
                        {% endif %}

                    </div>



                    {% if cart.free_shipping_rule and cart.free_shipping_rule.code %}
                        {% set status = cart.free_shipping_rule.subtotal_condition.status | default('') %}
                        {% set subtotal_condition = cart.free_shipping_rule.subtotal_condition %}
                        <div class="cart-discount-rule-wrapper free-shipping-rule-section mt-5 d-block">
                            <div class="d-flex align-items-center">
                            <div class="message flex-grow-1 free-shipping-rule-message">
                                {% if status == 'min_not_reached' %}
                                    {{ _("Add products with total of %(total)s to get free shipping") | format(total=subtotal_condition.remaining_to_min_total | default("0")) }}
                                {% elif status == 'max_exceed' %}
                                    {{ _("Free shipping applied for cart total between %(min)s and %(max)s") | format(min=subtotal_condition.min_total | default("0"), max=subtotal_condition.max_total | default("0")) }}
                                {% elif status == 'applied' %}
                                    {{  _("Free shipping applied") }}
                                {% endif %}
                            </div>

                            <div class="text-muted mr-1 flex-shrink-0 free-shipping-rule-read-more 
                                {% if status == 'min_not_reached' %}d-inline-block{% else %}d-none{% endif %}">
                                <a data-toggle="modal" data-target="#searchCitiesModal" href="#">
                                <small>{{ _("Read More") }}</small>
                                </a>
                            </div>

                            <div class="discount-progress flex-shrink-0">
                                <span class="free-shipping-rule-done 
                                    {% if status == 'applied' %}d-inline-block{% else %}d-none{% endif %}">
                                <span style="font-size: 28px" class="icon-done text-color-primary"></span>
                                </span>
                            </div>
                            </div>

                            <div class="{% if status == 'min_not_reached' %}d-block{% else %}d-none{% endif %} discount-progress-linear">
                            <div class="progress-bar free-shipping-rule-progress" style="width: {{ subtotal_condition.products_subtotal_percentage_from_min | default(0) }}%">
                                {% if status == 'applied' %}
                                <span>{{ _("Free Shipping") }}</span>
                                {% else %}
                                <span>{{ subtotal_condition.products_subtotal_percentage_from_min | default(0) }}%</span>
                                {% endif %}
                            </div>
                            </div>
                        </div>
                    {% endif %}



                    <div>
                        <div class="mt-5">
                            {% if store.settings.general.availability.is_store_closed %}
                                <a href="#"
                                   class="btn btn-lg btn-block btn-disabled"
                                >
                                    {{ _("Purchase") }}
                                </a>
                            {% else %}

                                <a href="/checkout"
                                class="btn btn-primary btn-lg btn-block"
                                >
                                    {{ _("Purchase") }}
                                </a>

                                <div style="margin-top: 1rem">
                                    {{ template_for_cart_apple_pay_button }}
                                </div>
                            {% endif %}

                        </div>

                        {% if store.settings.checkout.gift_order_settings.is_gift_order_enabled == '1' %}
                          <div class="card border-0 mt-3 text-body">
                              {{ template_for_cart_gifts_widget }}
                          </div>
                        {% endif %}

                        <div class="mt-3">
                            <a href="/" class="btn btn-outline-primary btn-lg btn-block">
                                {{ _("continue shopping") }}
                            </a>
                        </div>
                    </div>



                </div>
            </div>
            <div class="cart-empty pt-5 pbb-5 {% if cart.products_count > 0 %}d-none{% endif %}">
                <div class="d-flex flex-column align-items-center">
                    <span class="icon-shopping_cart_black_36dp-1-1 theme-title-primary" style="font-size: 90px">
                        <span class="path1"></span><span class="path2"></span>
                    </span>
                    <h2 class="mt-3">{{ _("Cart is empty") }}</h2>
                    <div class="mt-3">
                        <a href="/" class="btn btn-outline-primary btn-lg btn-block">
                            {{ _("continue shopping") }}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block footer_scripts %}
    <script type="text/javascript" src="{{ 'toastr.min.js' | asset_url }}"></script>

    {{ cart_view_scripts|safe }}

    <script>

        $( document ).ready(function() {
            addDeleteProgressImage()
        });

        function addDeleteProgressImage(){
            $('.cart-product-delete a .prefix', document).addClass('d-none');
            $('.cart-product-delete a .prefix', document).html('<img class="send-coupon-progress" src="{{ 'spinner.gif' | asset_url }}" width="15" height="15"/>');
        }

        $(document).on('click','.cart-product-delete a', function(event) {
            $('.icon-delete', event.currentTarget).addClass('d-none');
            $('.prefix',event.currentTarget).removeClass('d-none');
        });

        $(".cities-search-input").on('keyup', function (e) {
            const searchVal = e.target.value
            const mappedCities = cartObj.free_shipping_rule.shipping_cities_condition.map((city) => city.name);
            let filteredCities = mappedCities.slice(0, 50).join(' ، ');
            if (searchVal.length > 2) {
              filteredCities = mappedCities.filter((name) => name.trim().toLowerCase().includes(searchVal.trim().toLowerCase())).join(' ، ');
            }
            if (filteredCities.length) {
              $(".cities-result").html(filteredCities);
            } else {
              $(".cities-result").html('{{ _("No Result Found") }}');
            }
        });

        function sendCoupon() {
            if(!$('.send-coupon-progress').hasClass('d-none'))
                return;

            $('.send-coupon-progress').removeClass('d-none');
            zid.store.cart.redeemCoupon($('.send-coupon').val())
                .then(function (response) {
                    if(response.status  === 'success'){
                        toastr.success('{{ _("Send Successfully") }}', null)
                        window.location.reload();
                    }else{
                        toastr.error(response.data.message, '{{ _("Sorry") }}')
                    }
                    $('.send-coupon-progress').addClass('d-none');
                }).catch(function (err) {
                    $('.send-coupon-progress').addClass('d-none');
                })
        }

        function deleteCoupon() {
            if(!$('.delete-coupon-progress').hasClass('d-none'))
                return;

            $('.delete-coupon-progress').removeClass('d-none');
            zid.store.cart.removeCoupon().then(function (response) {
                if(response.status  === 'success'){
                    toastr.success('{{ _("Send Successfully") }}', null)
                    window.location.reload();
                }else{
                    toastr.error(response.data.message, '{{ _("Sorry") }}')
                }
                $('.delete-coupon-progress').addClass('d-none');
            })
        }


        function cartProductsHtmlChanged(html, cart){
            if(cart.products_count <= 0){
                $('.cart-products-with-totals').addClass('d-none');
                $('.cart-empty').removeClass('d-none');
                return;
            }else{
                $('.cart-products-with-totals').removeClass('d-none');
                $('.cart-empty').addClass('d-none');
            }


            $('.template_for_cart_products_list').html(html);

            if(cart &&  cart.totals){
                var strCartTotlas = '';
                for(var i = 0; i < cart.totals.length; i++){
                    var cartTotal = cart.totals[i];

                    var totalStyle = '';

                    if(cartTotal.code === 'total'){
                        totalStyle = 'font-weight: bold; color: var( --primary-color)';
                    }

                    var vat_included = '';
                    if(cartTotal.code === 'total'){

                        var is_cart_total_vat_included = {% if store.settings.general.tax_settings.is_tax_included_in_product_price %}true{% else %}false{% endif %};
                        var local_sys_lbl_cart_includes_vat = "{{ _('Includes TAX %(percentage)s') | format(percentage=store.settings.general.tax_settings.tax_percentage) }}";

                        if(is_cart_total_vat_included){
                            vat_included = '&nbsp;<small>'+local_sys_lbl_cart_includes_vat+'</small>';
                        }

                    }


                    strCartTotlas += '<div class="cart-product-row-wrapper cart-totals-row-wrapper">' +
                        '                                <div class="flex-grow-1">'+cartTotal.title+vat_included+'</div>' +
                        '                                <div class="flex-shrink-0" style="width: 30%; '+totalStyle+'">'+cartTotal.value_string+'</div>' +
                        '                            </div>'
                }

                $('.cart-totals-div').html(strCartTotlas);
            }

            if(cart.free_shipping_rule){
                $('.free-shipping-rule-section').removeClass('d-none')
                $('.free-shipping-rule-message').html(cart.free_shipping_rule.subtotal_condition.status)
                $('.free-shipping-rule-progress').css('width', `${cart.free_shipping_rule.subtotal_condition.products_subtotal_percentage_from_min}%`)
                if (cart.free_shipping_rule.subtotal_condition.status === 'applied') {
                    $('.free-shipping-rule-done').removeClass('d-none')
                    $('.free-shipping-rule-read-more').addClass('d-none')
                    $('.free-shipping-rule-progress').html('{{ _("Free Shipping") }}')
                }else {
                    $('.free-shipping-rule-done').addClass('d-none')
                    $('.free-shipping-rule-read-more').removeClass('d-none')
                    $('.free-shipping-rule-progress').html(`${cart.free_shipping_rule.subtotal_condition.products_subtotal_percentage_from_min}%`)
                }
            }else{
                $('.free-shipping-rule-section').addClass('d-none')
            }


            setCartTotalAndBadge(cart);
            addDeleteProgressImage();
        }

    </script>
{% endblock %}


{% block footer %} {% include 'footer.jinja' %} {% endblock %}
